<!-- META
{"title":"LLM-MARS: Large Language Model for Behavior Tree Generation and NLP-enhanced Dialogue in Multi-Agent Robot Systems","link":"https://arxiv.org/abs/2312.09348","media":"academic","tags":["llm","behaviortree","ai"],"short":{"en":"Earned high task execution accuracy and human-like behavior generation by fine-tuning a Large Language Model (Falcon 7B) with LoRa adapters for Behavior Tree generation and question-answering.","ja":"大規模言語モデル（Falcon 7B）をLoRaアダプタを用いてファインチューニングし、ビヘイビアツリー生成と質疑応答を行うことで、高いタスク実行精度と人間らしい振る舞い生成能力を得た論文"},"importance":2,"hasPage":true,"createdAt":1751287184.696,"updatedAt":1751287184.696}
META -->

# LLM-MARS: Large Language Model for Behavior Tree Generation and NLP-enhanced Dialogue in Multi-Agent Robot Systems
- Earned high task execution accuracy and human-like behavior generation by fine-tuning a Large Language Model (Falcon 7B) with LoRa adapters for Behavior Tree generation and question-answering.
- 大規模言語モデル（Falcon 7B）をLoRaアダプタを用いてファインチューニングし、ビヘイビアツリー生成と質疑応答を行うことで、高いタスク実行精度と人間らしい振る舞い生成能力を得た論文

## 著者
- Artem Lykov
- Maria Dronova
- Nikolay Naglov
- Mikhail Litvinov
- Sergei Satsevich
- Artem Bazhenov
- Vladimir Berman
- Aleksei Shcherbak
- Dzmitry Tsetserukou

## 背景
### 研究の意義
近年のロボット工学とAIの進展は著しく、特に大規模言語モデル（LLM）をロボットシステムに統合する研究が注目されています。 LLMは、自然言語で与えられた複雑なタスクを、ロボットが実行可能な単純なサブタスクに分解する能力を持っています。 本研究では、LLM-MARSという技術を提案します。これは、マルチエージェントロボットシステム（Multi-Agent Robot Systems）のためにLLMベースのAIを活用する初の技術です。 LLM-MARSは、人間とロボット間の動的な対話を可能にし、オペレーターのコマンドに基づいてロボットが振る舞いを生成し、自身の行動に関する質問に有益な回答を提供することを目的としています。 このアプローチは、特に物流、自律探査ミッション、インダストリー5.0といった分野に革命をもたらす大きな潜在能力を秘めています。 

### 関連研究
- **LLMの発展**: Transformerモデルの登場以来 、GPT-3.5やGPT-4などのLLMが大きな注目を集めています。 当初はOpenAIなどの一部の組織に限られていましたが、Google T5 やMetaのLLaMa 、そしてStanford Alpaca のようなオープンなLLMが登場したことで、研究者はカスタムデータでモデルをファインチューニングできるようになりました。 本研究では、当時高性能だったFalcon 7Bモデルを利用しています。 
- **ロボティクスにおけるLLM**: LLMをロボット工学に応用する研究は活発で、自然言語タスクをサブタスクに分解したり 、人間とロボットの対話システムを開発したりするのに利用されています。 PaLM-E やRT-2 のようなモデルは、実世界の操作タスクに取り組んでいます。Boston Dynamicsは、ロボット犬Spotが周囲を分析し、問い合わせに応答するシステムを開発しましたが、これは主に音声通信とナビゲーションに限定されています。 
- **ロボットの行動制御とビヘイビアツリー (BT)**: ロボットの行動を記述する手法として、従来から有限状態機械（FSM） やペトリネット 、そしてビヘイビアツリー（BT） が用いられてきました。BTは、複雑なロボットの振る舞いを記述するための階層的でモジュール化された構造であり、その柔軟性と直感性から広く利用されています。 
- **LLMによるBT生成**: LLMを用いてロボットのBTを生成する研究はまだ限定的です。 Y. Caoらの研究 では、OpenAIの製品を使ってBTのノードを埋める試みがありましたが、BTの構造を固定する必要があるという制約がありました。 これに対し、本研究ではLLMを特定のタスクに合わせてファインチューニングすることで、構造に制約のない多様なBTを生成することを目指します。 

## 手法
### 概要
LLM-MARSは、マルチエージェントロボットシステムを制御するための、LLMを基盤としたシステムです。 全体のアーキテクチャは以下の要素で構成されます。
- **ユーザー**: 自然言語でロボットにコマンドを与えたり、質問をしたりします。 
- **Falcon 7B LLM**: ユーザーからの入力を解釈し、2つの異なるタスクを実行します。 
- **第1 LoRaアダプタ (BT生成モジュール)**: ユーザーのコマンドに基づき、ロボットのビヘイビアツリー（BT）をXML形式で生成します。 
- **第2 LoRaアダプタ (質疑応答モジュール)**: ロボットの行動結果（XML形式）とユーザーの質問に基づき、自然言語で回答を生成します。 
- **マルチエージェントロボットシステム**: 生成されたBTを実行し、その結果をシステムにフィードバックします。 

このシステムは、一つのLLMコアと複数のLoRaアダプタを切り替えて使用することで、計算資源を効率的に活用し、多様なタスクに対応するマルチモーダル性を実現しています。 

### 前提条件
- **ロボットシステム**: 本研究では、ロボット競技会「Eurobot 2023」のルールに基づいた2台の自律移動ロボット（Black SamuraiとOrange Shogan）を対象としています。 
- **インフラ**: ロボット本体には70億パラメータのLLMを搭載するハードウェアがないため、LLMはNVIDIA Tesla V100を搭載したリモートサーバー上で実行されます。 ロボットはSSH経由でサーバーにリクエストを送信し、生成されたBTや回答を受信します。 
- **既存のロボット機能**: ロボットは、元々BT形式で戦略を実行できる高レベル・低レベルのシステムを備えている必要があります。 

### 詳細
- **LLMのファインチューニング**:
    - ベースモデルとしてFalcon 7Bを使用しました。 
    - モデル全体の再トレーニングを避けるため、計算コストの低いLow-Rank Adaptation (LoRA) というPEFT（Parameter-Efficient Fine-Tuning）手法を採用しました。 
- **データセット生成**:
    - **BT生成用データセット**:
        - Pythonスクリプトを用いて、ロボットが実行可能なアクションの組み合わせからなる多様なBTを生成しました。 
        - 各BTに対応する自然言語のコマンド記述は、テンプレートに従って生成した後、ChatGPT APIを用いてより自然な表現に言い換えました。 
        - これにより、戦略的に有効かつ多様な表現を持つ7,500サンプルのデータセットを作成しました。 
    - **質疑応答用データセット**:
        - ロボットの行動結果を示すXMLファイルと、それに関する質問、そして模範解答のペアを生成しました。 
        - ChatGPT APIを利用して、様々な状況を想定した11,000サンプルの質疑応答データセットを生成しました。 
- **マルチモーダルアダプタ**:
    - 上記の2つのデータセットを用いて、それぞれBT生成用と質疑応答用のLoRaアダプタを個別にファインチューニングしました。 
    - 1つのアダプタで両方のタスクを行わせることも試みましたが、BTの構造的正当性が損なわれたため、タスクごとにアダプタを切り替える方式を採用しました。 アダプタの切り替えには約40秒を要します。 
- **ロボットシステムの構成**:
    - **機械構造**: Eurobotの規定に準拠し、オムニホイール、グリッパー、ソート機構、チェリー（球状オブジェクト）の収集・分注機構などを備えています。 
    - **組込みシステム**: STM32F407 MCUを搭載したメイン制御ボードが、モータードライバやセンサーなどの低レベル制御と電源管理を担います。 
    - **高レベルシステム**:
        - Intel NUC上でROS2 Humbleが動作し、LIDARやカメラからのデータ処理、高度な戦略決定を行います。 
        - **自己位置推定**: パーティクルフィルタを用い、車輪エンコーダ、LIDAR、コンピュータビジョンからの情報を統合して高精度な自己位置推定を実現します。 
        - **コンピュータビジョン (CV)**: Jetson Xavier AGXと魚眼レンズ付きカメラを使用し、Hough変換によるゲームオブジェクト（ケーキ）の検出 や、ロボット上のAruCoマーカーを用いた正確な位置特定を行います。 
        - **ナビゲーション**: RRT*アルゴリズムを用いて安全な経路を生成し、最小躍度（minimum jerk）アルゴリズムで滑らかな速度プロファイルを生成してロボットを制御します。 
        - **BTモジュール**: `behavior-tree-cpp-v3`ライブラリを使用し、アクチュエータへのコマンドをラップしたアクションノードや条件ノードを用いて、XMLファイルとして記述された戦略を実行します。 

### 評価方法
3つの異なる実験を通じて、提案システムの性能を評価しました。
- **実験1: 人間によるBTの識別能力評価**:
    - LLMが生成したBTと人間が手動で作成したBTを、人間が見分けられるかを評価しました。 
    - 15人の参加者（ロボット工学を専攻する学生、うち10人はBT使用経験者）に、10組のBTペア（LLM生成と人間作成）を提示し、どちらがLLMによって作られたかを推測させました。 
- **実験2: BT生成の性能評価**:
    - 実際のマルチエージェントロボットシステム上で、与えられたタスクをLLMがどれだけ正確にBTに反映できるかを評価しました。 
    - 1つから6つのタスクを含むコマンドを計60個LLMに与え、生成されたBTにタスクが正しく組み込まれているかの精度を分析しました。 
- **実験3: 質疑応答の専門家評価**:
    - LLMが生成したロボットの行動に関する50の回答を、10人の専門家が評価しました。 
    - 評価基準は「正確性（Accuracy）」「関連性（Relevance）」「情報性（Informativeness）」の3つとし、評価者間の一致度を検証するためにKrippendorffのα信頼性係数を計算しました。 

## 結果
### 概要
実験結果は、LLM-MARSが有望な性能を示すことを実証しました。 複数のタスクを含む複合コマンドにおいて、ロボットは平均79.28%のタスク実行精度を達成しました。 特に、タスク数が2つ以下のコマンドでは、精度は90%を超えました。 また、オペレーターの質問に対するシステムの回答は、高い正確性、関連性、情報性を持つことが専門家評価によって確認されました。 

### 詳細
- **実験1: 人間によるBTの識別能力評価**:
    - 参加者の正答数の平均は10問中4.53問であり、ランダムな推測（5問）とほぼ同等の結果でした。 
    - 分散分析（ANOVA）の結果、特定の質問によって正答率が変わるという証拠は見られませんでした（$F=0.75, p=0.66>0.05$）。 
    - t検定の結果、平均スコアは統計的に0.5と有意な差がないことが示され、人間とLLMが生成したBTは主観的に区別できないという帰無仮説を棄却できませんでした。 
    - これは、LLMが人間が作成したものと遜色ない品質のBTを生成できることを示唆しています。 
- **実験2: BT生成の性能評価**:
    - 全てのタスクにおいて、LLMは与えられたタスクの70.44%をBTに正確に統合しました。 
    - 1つのコマンド内で正しく追加されたタスクの平均割合は79.28%でした。 
    - タスクの統合精度はコマンドに含まれるタスク数に影響されることが、ANOVA分析で確認されました（$F=2.61, p=0.035$）。 タスク数が少ないほど性能が高く、6タスクの場合に若干性能が向上する傾向が見られました。これは、データセット生成に使用したEurobotの戦略が、多くのタスクを含むためと考えられます。 
- **実験3: 質疑応答の専門家評価**:
    - 回答の平均スコアは、正確性が72.8%、関連性が4.71/5.0、情報性が4.89/5.0と高い評価を得ました。 
    - Krippendorffのα信頼性係数は、正確性で0.8239（強い一致）、関連性で0.7229（中程度の一致）、情報性で0.7594（中程度の一致）でした。 
    - 関連性と情報性の一致度が中程度に留まったのは、これらの評価基準が本質的に主観的であるためと考えられます。 

## 先行研究との差分
### 手法面
- **柔軟なBT構造の生成**: Y. Caoらの研究 では、LLMを使いつつもBTの基本構造（シーケンスとアクションノードのみ）が固定されていました。 本研究では、オープンなLLM（Falcon 7B）をBT生成用にファインチューニングすることにより、構造に制約のない、より多様で複雑なBTを生成することが可能です。 
- **マルチモーダルな単一LLM**: Boston Dynamicsの研究 では、主に質疑応答にLLMが利用されていました。本研究では、1つのLLMと複数のLoRaアダプタを切り替えるアプローチにより、BT生成と質疑応答という異なるタスクを単一のモデルで効率的に処理します。 
- **オープンモデルの活用とデータ生成**: OpenAIのAPIに依存するのではなく、オープンなLLMをファインチューニングし、データセット自体も半自動的に（スクリプトとChatGPT APIを組み合わせて）生成する手法を採用しています。 

### 結果面
- 結果の比較なし

## 議論
- **成果**: 本研究は、人間と対話し、そのコマンドに基づいてエージェントの複雑な行動戦略を構築し、タスク実行に関するフィードバックを提供するマルチエージェントロボットシステムを開発する技術を実証しました。 
- **課題と将来の展望**:
    - 現在のモデルは、コマンドに含まれるタスク数が多くなると性能が低下する傾向があります。 
    - 将来的な改善策として、複雑なコマンドをまず単純なサブタスクに分解し、その後で各サブタスクに対応するBTを生成する、という2段階のアプローチが考えられます。 
    - この分解機能は、BT生成用アダプタに新たな機能として追加するか、専用の分解アダプタを別途トレーニングすることで実現できる可能性があります。 
- **応用可能性**: この技術は、1つのLLMが多数のロボットを制御する「スウォームAI」の実現に向けた重要な一歩です。 これにより、人間の専門家が各ロボットを個別にプログラミングする必要がなくなり、物流倉庫の完全自動化 、ドローン群による自律探査 、インダストリー5.0で目指される人間と機械の協働 など、幅広い応用が期待されます。